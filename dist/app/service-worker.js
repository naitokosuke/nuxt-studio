const n=()=>"\nconst DB_NAME = 'studio-media'\nconst STORE_NAME = 'drafts'\n\nconst DraftStatus = {\n  Deleted: 'deleted',\n  Created: 'created',\n  Updated: 'updated',\n  Pristine: 'pristine'\n}\n\nconst MEDIA_EXTENSIONS = [\n  'png',\n  'jpg',\n  'jpeg',\n  'svg',\n  'webp',\n  'avif',\n  'ico',\n  'gif',\n  'mp4',\n  'mov',\n  'avi',\n  'mkv',\n  'webm',\n  'ogg',\n  'mp3',\n  'wav',\n  'aac',\n  'm4a',\n  'm4v',\n  'm4b',\n]\n\nfunction extractImagePath(url) {\n  const pathname = url.pathname;\n  if (pathname.startsWith('/_ipx/_/')) {\n    return pathname.replace('/_ipx/_', '')\n  }\n\n  if (pathname.startsWith('/_vercel/image')) {\n    return url.searchParams.get('url') || null\n  }\n\n  if (MEDIA_EXTENSIONS.includes(pathname.split('.').pop())) {\n    return pathname\n  }\n\n  return null\n}\n\nself.addEventListener('install', event => {\n  self.skipWaiting()\n})\n\nself.addEventListener('activate', event => {\n  event.waitUntil(self.clients.claim())\n})\n\nself.addEventListener('fetch', event => {\n  const url = new URL(event.request.url);\n  const isSameDomain = url.origin === self.location.origin;\n\n  if (!isSameDomain) {\n    return\n  }\n\n  const imageUrl = extractImagePath(url);\n  if (imageUrl) {\n    return event.respondWith(fetchFromIndexedDB(event, imageUrl));\n  }\n})\n\nfunction fetchFromIndexedDB(event, url) {\n  const dbKey = url.replace(/^\\//g, '').replace(/\\//g, ':')\n  return getData(dbKey).then(data => {\n    if (!data) {\n      return fetch(event.request);\n    }\n\n    const dbItem = JSON.parse(data)\n\n    console.log('Data found in IndexedDB:', dbItem);\n\n    // Deleted file\n    if (dbItem.status === DraftStatus.Deleted) {\n      return fetch('https://placehold.co/1200x800?text=Deleted');\n    }\n\n    // Renamed file\n    if (dbItem.original?.path) {\n      return fetch(dbItem.original.path);\n    }\n\n    // Created file\n    const parsed = parseDataUrl(dbItem.modified.raw);\n    const bytes = base64ToUint8Array(parsed.base64);\n\n    return new Response(bytes, {\n      headers: { 'Content-Type': parsed.mime }\n    });\n  })\n}\n\nfunction parseDataUrl(dataUrl) {\n  // Example: data:image/png;base64,iVBORw0KG...\n  const match = dataUrl.match(/^data:(.+);base64,(.+)$/);\n  if (!match) return null;\n  return {\n    mime: match[1],\n    base64: match[2]\n  };\n}\n\nfunction base64ToUint8Array(base64) {\n  const binary = atob(base64);\n  const len = binary.length;\n  const bytes = new Uint8Array(len);\n  for (let i = 0; i < len; i++) {\n    bytes[i] = binary.charCodeAt(i);\n  }\n  return bytes;\n}\n\n// IndexedDB\nfunction openDB() {\n  return new Promise((resolve, reject) => {\n    const request = indexedDB.open(DB_NAME, 1);\n    request.onupgradeneeded = event => {\n      const db = event.target.result;\n      db.createObjectStore(STORE_NAME, { keyPath: 'id' });\n    };\n    request.onsuccess = event => resolve(event.target.result);\n    request.onerror = event => reject(event.target.error);\n  });\n}\n\n// Read data from the object store\nfunction getData(key) {\n  return openDB().then(db => {\n    return new Promise((resolve, reject) => {\n      const tx = db.transaction('drafts', 'readonly');\n      const store = tx.objectStore('drafts');\n      const request = store.get(key);\n      request.onsuccess = () => resolve(request.result);\n      request.onerror = () => reject(request.error);\n    });\n  });\n}\n";export{n as serviceWorker};
